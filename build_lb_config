#!/usr/bin/env bash

###
### Interesting constants
###
LB_VIP_IF_NAME=eth0:1
LB_VIP_IF_IP=10.0.0.101
LB_VIP_IF_PREFIX_LEN=24
LB_SRC_IF_NAME=eth0:2
LB_SRC_IF_IP=10.0.0.102
LB_SRC_IF_PREFIX_LEN=24
# One AS for now
AS1_DST_IF_NAME=eth0:3
AS1_DST_IF_IP=10.0.0.1023
AS1_DST_IF_PREFIX_LEN=24


###
### Uninteresting constants
###
VPP_CONFIG_FILE="$(dirname $0)/test_lb.conf"
VPP_TMP_CLI_CONFIG_FILE="/tmp/vpp_cli_config"
VPP_CONFIGURE_SCRIPT="$(dirname $0)/vpp_configure"


###
### Functions
###
# Add item to VPP CLI config
rm -f "$VPP_TMP_CLI_CONFIG_FILE"
echo "#!/usr/bin/env bash" > "$VPP_CONFIGURE_SCRIPT"
# touch "$VPP_TMP_CLI_CONFIG_FILE"
function vpp_add_cli_config() {
    echo "  $*" >> "$VPP_TMP_CLI_CONFIG_FILE"
    # Shouldn't need both of these, but running VPP with the `-c` option seems to ignore `unix-cli` config...
    echo "vppctl $*" >> "$VPP_CONFIGURE_SCRIPT"
}


###
### VPP
###

# Add VIP and SRC interfaces to VPP
vpp_add_cli_config create host-interface name ${LB_VIP_IF_NAME}
vpp_add_cli_config create host-interface name ${LB_SRC_IF_NAME}

# Set up the LB source IP
# @@@ This line causes bad tcp checksum errors (without going through LB)
# vpp_add_cli_config set int ip address host-${LB_VIP_IF_NAME} ${LB_}/8
vpp_add_cli_config set int ip address host-lo:1 127.0.0.3/8

# Bring these up
vpp_add_cli_config set interface state host-lo:0 up
vpp_add_cli_config set interface state host-lo:1 up


###
### VPP LB
###

# Set up the LB to send from .3
vpp_add_cli_config lb conf ip4-src-address 127.0.0.3 buckets 32

# Set the VIP to .2
vpp_add_cli_config lb vip 127.0.0.2/32 encap gre4

# Add an AS - at .4
vpp_add_cli_config lb as 127.0.0.2/32 127.0.0.4


###
### GRE
###

# Create GRE tunnel in VPP (seems to make no difference at present)
vpp_add_cli_config create gre tunnel src 127.0.0.3 dst 127.0.0.4

# Two options here it seems - neither work...
USE_GRETAP=1
if [[ $USE_GRETAP -ne 0 ]]
then
    # Use gretap
    sudo ip link add gre2 type gretap remote 127.0.0.3 local 127.0.0.4 ttl 255
    sudo ip link set gre2 up

    # Do we need to have a route to 127.0.0.2 through the GRE tunnel?
    sudo ip addr add 127.0.0.2/32 dev gre2
    sudo ip addr add 127.0.0.4/32 dev gre2
else
    sudo ip tunnel add gre1 mode gre remote 127.0.0.3 local 127.0.0.4 ttl 255
    sudo ip link set gre1 up

    # Do we need to have a route to 127.0.0.2 through the GRE tunnel?
    sudo ip addr add 127.0.0.2/32 dev gre1
    sudo ip addr add 127.0.0.4/32 dev gre1
fi


###
### Display config
###
vpp_add_cli_config show interface
vpp_add_cli_config show lb
vpp_add_cli_config show lb vip verbose
vpp_add_cli_config show ip fib


###
### Output the config
###
echo "unix-cli {" > "$VPP_CONFIG_FILE"
cat "$VPP_TMP_CLI_CONFIG_FILE" >> "$VPP_CONFIG_FILE"
cat << CONFIG >> "$VPP_CONFIG_FILE"
}
unix {
  nodaemon
  log /tmp/vpp.log
  cli-listen localhost:5002
}
api-trace {
  on
}
CONFIG

###
### Make configuration script executable
###
chmod +x "$VPP_CONFIGURE_SCRIPT"
